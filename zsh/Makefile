# Github stuff
GH_API_URL := https://raw.githubusercontent.com
GH_URL := https://github.com

# generic config files
ZSHRC := .zshrc

# oh-my-zsh
OMZ := ohmyzsh
OMZ_SCRIPT_URL := $(GH_API_URL)/$(OMZ)/$(OMZ)/master/tools/install.sh
OMZ_INSTALLER := ./$(OMZ).install.sh
OMZ_DIR := ~/.oh-my-zsh
OMZ_STARTUP := $(OMZ_DIR)/oh-my-zsh.sh
OMZ_THEMES := $(OMZ_DIR)/custom/themes

# spaceship-prompt
SSP := spaceship-prompt
SSP_REPO := $(GH_URL)/$(SSP)/$(SSP).git
SSP_DEST := $(OMZ_THEMES)/$(SSP)
SSP_THEME := $(SSP_DEST)/spaceship.zsh-theme

.PHONY: all zsh $(OMZ) $(SSP)

all: zsh $(OMZ) $(SSP)

$(OMZ): zsh $(OMZ_STARTUP) 

$(OMZ_STARTUP): $(OMZ_INSTALLER)
	@if ! [ -d $(OMZ_DIR) ]; then \
		echo "Running oh-my-zsh install script..."; \
		sh "$(OMZ_INSTALLER)"; \
	fi

$(OMZ_INSTALLER):
	@echo "Downloading oh-my-zsh install script...";
	@curl -fsSL "$(OMZ_SCRIPT_URL)" -o "$(OMZ_INSTALLER)";

config: zsh $(OMZ) $(ZSHRC)
	@if [ -f ~/$(ZSHRC) ]; then \
		echo "Replacing oh-my-zsh autogenerated .zshrc with personalized version..." \
		mv ~/$(ZSHRC) ~/$(ZSHRC).oh-my-zsh.auto \
	fi 
	@ln -s $(shell realpath ./$(ZSHRC)) ~/.$(ZSHRC)

$(SSP): $(SSP_THEME)

$(SSP_THEME): zsh $(OMZ)
	@mkdir -p "$(dir $(SSP_DEST))" && \
		git clone  "$(SSP_REPO)" --depth=1 "$(SSP_DEST)" && \
		ln -s "$(SSP_THEME)" "$(OMZ_THEMES)/$(basename $(SSP_THEME))"

zsh:
	@command -v zsh >/dev/null 2>&1 || \
		sudo dnf install zsh -y
